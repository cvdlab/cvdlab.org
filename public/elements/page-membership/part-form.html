<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<polymer-element name="part-form">
  <template>
    <link rel="stylesheet" href="../../styles/bootstrap.min.css">
    <style>
      :host { 
        display: block;
      }

      #submit {
        margin-top: 36px;
        margin-bottom: 36px;
      }

      h1 {
        margin-bottom: 18px;
      }

      .form-group input, 
      .form-group select {
        border-radius: 2px;
        box-shadow: none;
        outline: none;
      }

      #picture {
        background-size: cover;
        position: relative;
        width: 200px;
        height: 200px;
      }

      #file {
        display: none;
      }

      #change_picture {
        margin-top: 18px;
        margin-bottom: 18px;
      }
    </style>

    <core-ajax auto url="/api/v0/alumni/{{ id }}" handleAs="json" on-core-response="{{on_get_data}}">
    </core-ajax>
    <core-ajax id="send_data" method="POST" url="/api/v0/alumni/{{ id }}" handleAs="json" on-core-response="{{on_send_data}}">
    </core-ajax>
    <core-ajax id="send_picture" url="/api/v0/alumni/{{ id }}" handleAs="json" on-core-response="{{on_send_picture}}">
    </core-ajax>

    <div class="container">
      <h1 id="id-label"><span class="label label-default">{{ id }}</span></h1>
      <div>
        <template if="{{ alumnus.has_picture }}">
          <div id="picture" style="background-image: url({{ 'images/' + id + '/thumb.jpg' }})"></div>
        </template>
        <template if="{{ !alumnus.has_picture }}">
          <div id="picture" style="background-image: url('../../images/profile.jpg')"></div>
        </template>
        <input id="file" type="file" on-change="{{ change_file }}" files="{{ input_files }}" class="btn btn-primary">
        <button id="change_picture" on-click="{{ change_picture }}" class="btn btn-primary">Change picture</button>
      </div>
      <form role="form">
        <div class="form-group">
          <label for="full_name">Full name</label>
          <input type="text" class="form-control input-lg" id="full_name" name="full_name" placeholder="Enter your name and surname" value="{{ alumnus.full_name }}">
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" class="form-control input-lg" id="email" name="email" placeholder="Enter your email address" value="{{ alumnus.email }}">
        </div>
        <div class="form-group">
          <label for="website">Personal website address [optional]</label>
          <input type="url" class="form-control input-lg" id="website" name="website" placeholder="Enter your personal website address, if any" value="{{ alumnus.website }}">
        </div>
        <div class="form-group">
          <label for="github_username">GitHub username</label>
          <input type="text" class="form-control input-lg" id="github_username" name="github_username" placeholder="Enter your GitHub username" value="{{ alumnus.github_username }}">
        </div>
        <div class="form-group">
          <label for="year">Year</label>
          <select class="form-control input-lg" id="year" name="year" value="{{ alumnus.year }}">
            <option value="">Select the year in which you take the course</option>
            <option value="2012" selected?="{{ alumnus.year == 2012 }}">2012</option>
            <option value="2013" selected?="{{ alumnus.year == 2013 }}">2013</option>
            <option value="2014" selected?="{{ alumnus.year == 2014 }}">2014</option>
          </select>
        </div>
      </form>
      <button id="submit" on-click="{{ submit }}" class="btn btn-lg {{submit_button_type}} btn-block">{{ submit_text }}</button>
    </div>
  </template>
  <script>
    Polymer('part-form', {

      submit_text: 'Submit',

      submit_button_type: 'btn-primary',

      on_response: function (event, detail, sender) {
        var response = detail.response;
        this.alumnus = response;
      },

      submit: function (e) {
        e.preventDefault();
        var self = this;
        var $ = this.$;

        var data = {
          full_name: this.alumnus.full_name,
          email: this.alumnus.email,
          website: this.alumnus.website,
          github_username: this.alumnus.github_username,
          year: +this.alumnus.year
        };

        request
          .post(endpoint)
          .send(data)
          .end(function (res) {
            self.submit_text = "Submitted :P thank you!";
            self.submit_button_type = "btn-success";
          });
      },

      get_picture_url: function () {
        return 'images/' + this.id + '/thumb.jpg';
      },

      change_picture: function (e) {
        this.$.file.click();
      },

      change_file: function (e) {
        var self = this;

        var file_input = this.$.file;
        var file = file_input.files[0];
        var form_data = new FormData();
        form_data.append('file', file);

        var xhr = new XMLHttpRequest();
        xhr.onload = function (e) {
          if(xhr.status == 200) {
            self.alumnus.has_picture = true;
          }
        }
        xhr.open('POST', endpoint + '/picture', true);
        xhr.send(form_data);
      }

    });
  </script>
</polymer-element>