<template-element id="app-container">
  <template>
    <link rel="stylesheet" href="/styles/style-layout.css">

    <div ref="container" on-action="on_action"></div>

  </template>
</template-element>

<script>
  class AppContainer extends Pantarei.Element {

    get routes () {
      return [
        '/',
        '/404',
        '/about',
        '/blog',
        '/contacts',
        '/cookies',
        '/courses',
        '/home',
        '/people',
        '/projects',
        '/theses'
      ]
    }

    get context () {
      return {
        title: "CVDLAB",
        menu: {
          main: [
            { label: 'about', href: '/about' },
            { label: 'people', href: '/people' },
            { label: 'projects', href: '/projects' },
            { label: 'theses', href: '/theses' },
            { label: 'courses', href: '/courses' },
            // { label: 'blog', href: '/blog' },
            { label: 'contacts', href: '/contacts' }
          ],
          about: [
            { label: 'what', href: '#what' },
            { label: 'who', href: '#who' },
            { label: 'why', href: '#why' },
            { label: 'when', href: '#when' },
            { label: 'where', href: '#where' }
          ],
          people: [
            { label: 'members', href: '#members' },
            { label: 'collaborators', href: '#collaborators' },
            { label: 'alumni', href: '#alumni' },
          ]
        }
      }
    }

    after_create () {
      this.imported = {}

      page('*', this.handle_route.bind(this))

      let pathname = location.pathname || '/'

      let redirect = sessionStorage.redirect
      if (redirect) {
        pathname = redirect
        sessionStorage.removeItem('redirect')
      }

      page()
      page(pathname)
    }

    handle_route (route) {
      let path = route.path
      let hash = route.hash

      if (!this.routes.includes(path)) {
        page.redirect('/404')
        return
      }

      if (path === '/') {
        path = '/home'
      }

      path = path.slice(1)
      let pagename = `page-${path}`
      let href = `/elements/${pagename}.html`

      this.import_page(href)
        .then(() => {
          let page = this.open_page(pagename)
          page.route = route
          localStorage.location = route.pathname
        })
        .catch(() => {
          page('/404')
        })
    }

    import_page (href) {
      return new Promise((resolve, reject) => {
        let links = this.imported
        let link = links[href]
        if (link) {
          resolve(link)
          return
        }

        link = document.createElement('link')
        link.rel = 'import'
        link.href = href

        link.onload = function (event) {
          links[href] = link
          resolve(link)
        }
        link.onerror = function () {
          reject(link)
        }

        document.head.appendChild(link)
      })
    }

    open_page (page_name) {
      let container = this.refs.container
      while (container.firstChild) {
        container.firstChild.remove()
      }
      let page = document.createElement(page_name)
      page.context = this.context
      this.page = page
      window.ga && ga('send', 'pageview', '/' + page_name)
      container.appendChild(page)
      return page
    }

    on_action (event, action) {
      let method = this['do_' + action.name]
      if (!method) {
        return
      }
      method.call(this, action.data)
    }

    do_fetch (name) {
      fetch(`data/${name}.json`, {
        method: 'get',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        }
      })
      .then(function (response) {
        if (response.ok) {
          return response.json()
        }
      })
      .then(function (data) {
        this.page[name] = data
        this.page.update()
      }.bind(this))
    }

    do_fetch_technologies () {
      let name = 'technologies'
      fetch(`data/${name}.json`, {
        method: 'get',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        }
      })
      .then((response) => {
        if (response.ok) {
          return response.json()
        }
      })
      .then((data) => {
        data = data.map(function (technology) {
          return {
            name: technology,
            style: `background-image: url('/images/${technology}.png');`
          }
        })
        this.page[name] = data
        this.page.update()
      })
    }

    do_blog () {
      var url = 'https://api.github.com/repos/cvdlab/cvdlab.org/contents/articles';
      fetch(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/vnd.github.v3.raw+json',
            'Content-Type': 'application/vnd.github.v3.raw+json'
          }
        })
        .then((response) => response.json())
        .then((articles) => {
          this.page.articles = articles
          articles.forEach((article) => {
            fetch(article.download_url)
              .then((response) => response.text())
              .then((text) => {
                article.content = text
                this.page.update()
              })
          })
        })
        .catch((error) => {
          console.log(error)
        })
    }

  }

  document.registerElement('app-container', AppContainer)
</script>
