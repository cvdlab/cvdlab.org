<link rel="import" href="app-link.html">

<template-element id="app-container">
  <template>
    <style>
      :host > * {

        --layout: {
          display: -ms-flexbox;
          display: -webkit-flex;
          display: flex;
        };

        --layout-inline: {
          display: -ms-inline-flexbox;
          display: -webkit-inline-flex;
          display: inline-flex;
        };

        --layout-horizontal: {
          @apply --layout;
          -ms-flex-direction: row;
          -webkit-flex-direction: row;
          flex-direction: row;
        };

        --layout-horizontal-reverse: {
          @apply --layout;
          -ms-flex-direction: row-reverse;
          -webkit-flex-direction: row-reverse;
          flex-direction: row-reverse;
        };

        --layout-vertical: {
          @apply --layout;
          -ms-flex-direction: column;
          -webkit-flex-direction: column;
          flex-direction: column;
        };

        --layout-vertical-reverse: {
          @apply --layout;
          -ms-flex-direction: column-reverse;
          -webkit-flex-direction: column-reverse;
          flex-direction: column-reverse;
        };

        --layout-wrap: {
          -ms-flex-wrap: wrap;
          -webkit-flex-wrap: wrap;
          flex-wrap: wrap;
        };

        --layout-no-wrap: {
          -ms-flex-wrap: nowrap;
          -webkit-flex-wrap: nowrap;
          flex-wrap: nowrap;
        };

        --layout-wrap-reverse: {
          -ms-flex-wrap: wrap-reverse;
          -webkit-flex-wrap: wrap-reverse;
          flex-wrap: wrap-reverse;
        };

        --layout-flex-auto: {
          -ms-flex: 1 1 auto;
          -webkit-flex: 1 1 auto;
          flex: 1 1 auto;
        };

        --layout-flex-none: {
          -ms-flex: none;
          -webkit-flex: none;
          flex: none;
        };

        --layout-flex: {
          -ms-flex: 1 1 0.000000001px;
          -webkit-flex: 1;
          flex: 1;
          -webkit-flex-basis: 0.000000001px;
          flex-basis: 0.000000001px;
        };

        --layout-start: {
          -ms-flex-align: start;
          -webkit-align-items: flex-start;
          align-items: flex-start;
        };

        --layout-center: {
          -ms-flex-align: center;
          -webkit-align-items: center;
          align-items: center;
        };

        --layout-end: {
          -ms-flex-align: end;
          -webkit-align-items: flex-end;
          align-items: flex-end;
        };

        --layout-baseline: {
          -ms-flex-align: baseline;
          -webkit-align-items: baseline;
          align-items: baseline;
        };

        --layout-start-justified: {
          -ms-flex-pack: start;
          -webkit-justify-content: flex-start;
          justify-content: flex-start;
        };

        --layout-center-justified: {
          -ms-flex-pack: center;
          -webkit-justify-content: center;
          justify-content: center;
        };

        --layout-end-justified: {
          -ms-flex-pack: end;
          -webkit-justify-content: flex-end;
          justify-content: flex-end;
        };

        --layout-around-justified: {

          -ms-flex-pack: distribute;
          -webkit-justify-content: space-around;
          justify-content: space-around;
        };

        --layout-justified: {
          -ms-flex-pack: justify;
          -webkit-justify-content: space-between;
          justify-content: space-between;
        };

        --layout-center-center: {
          @apply --layout-center;
          @apply --layout-center-justified;
        };

        --layout-self-start: {
          -ms-align-self: flex-start;
          -webkit-align-self: flex-start;
          align-self: flex-start;
        };

        --layout-self-center: {
          -ms-align-self: center;
          -webkit-align-self: center;
          align-self: center;
        };

        --layout-self-end: {
          -ms-align-self: flex-end;
          -webkit-align-self: flex-end;
          align-self: flex-end;
        };

        --layout-self-stretch: {
          -ms-align-self: stretch;
          -webkit-align-self: stretch;
          align-self: stretch;
        };

        --layout-self-baseline: {
          -ms-align-self: baseline;
          -webkit-align-self: baseline;
          align-self: baseline;
        };

        --layout-start-aligned: {
          -ms-flex-line-pack: start;
          -ms-align-content: flex-start;
          -webkit-align-content: flex-start;
          align-content: flex-start;
        };

        --layout-end-aligned: {
          -ms-flex-line-pack: end;
          -ms-align-content: flex-end;
          -webkit-align-content: flex-end;
          align-content: flex-end;
        };

        --layout-center-aligned: {
          -ms-flex-line-pack: center;
          -ms-align-content: center;
          -webkit-align-content: center;
          align-content: center;
        };

        --layout-between-aligned: {
          -ms-flex-line-pack: justify;
          -ms-align-content: space-between;
          -webkit-align-content: space-between;
          align-content: space-between;
        };

        --layout-around-aligned: {
          -ms-flex-line-pack: distribute;
          -ms-align-content: space-around;
          -webkit-align-content: space-around;
          align-content: space-around;
        };

        --layout-block: {
          display: block;
        };

        --layout-invisible: {
          visibility: hidden !important;
        };

        --layout-relative: {
          position: relative;
        };

        --layout-fit: {
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
        };

        --layout-scroll: {
          -webkit-overflow-scrolling: touch;
          overflow: auto;
        };

        --layout-fullbleed: {
          margin: 0;
          height: 100vh;
        };

        --layout-fixed-top: {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
        };

        --layout-fixed-right: {
          position: fixed;
          top: 0;
          right: 0;
          bottom: 0;
        };

        --layout-fixed-bottom: {
          position: fixed;
          right: 0;
          bottom: 0;
          left: 0;
        };

        --layout-fixed-left: {
          position: fixed;
          top: 0;
          bottom: 0;
          left: 0;
        };

        --layout-over: {
          z-index: 100;
        };

        --layout-box: {
          box-sizing: border-box;
        };

        --layout-container: {
          @apply --layout-box;
          width: 100%;
          max-width: var(--container-max-width);
          margin-left: auto;
          margin-right: auto;
          padding-left: 0.9375rem;
          padding-right: 0.9375rem;
        };

        --layout-row: {
          @apply --layout-flex;
          @apply --layout-wrap;
          margin-left: -0.9375rem;
          margin-right: -0.9375rem;
        };

        --text-antialiased: {
          -webkit-font-smoothing: antialiased;
        };

        --text: {
          @apply --text-antialiased;
          line-height: 2;
        };

      }

      @media (min-width: 544px) {
        :host > * {
          --container-max-width: 576px;
        }
      }

      @media (min-width: 768px) {
        :host > * {
          --container-max-width: 720px;
        }
      }

      @media (min-width: 992px) {
        :host > * {
          --container-max-width: 940px;
        }
      }

      @media (min-width: 1200px) {
        :host > * {
          --container-max-width: 1140px;
        }
      }

    </style>

    <div id="container"></div>

  </template>
</template-element>

<script src="../data/menu.js"></script>
<script src="../data/pages.js"></script>
<script src="../data/data.js"></script>
<script src="../data/alumni.js"></script>
<script src="../data/collaborators.js"></script>
<script src="../data/courses.js"></script>
<script src="../data/crumbs.js"></script>
<script src="../data/founders.js"></script>
<script src="../data/hello.js"></script>
<script src="../data/projects.js"></script>
<script src="../data/theses.js"></script>
<script>
  class AppContainer extends Pantarei.Element {

    static get is () {
      return 'app-container'
    }

    static page_url (page_name) {
      return `/elements/${page_name}.html`
    }

    static get brand () {
      return 'CVDLAB'
    }

    constructor () {
      super()
      this._imported = {}
      this._pages = {}
      this._page = null
      this._page_name = ''
      this._pathname = location.pathname || '/'
    }

    ready () {
      this._register_menus(Pantarei.menu, Pantarei.pages)
      this._register_pages(Pantarei.pages)
      this._redirect()
    }

    _register_pages (pages) {
      page()
      for (let page_name in pages) {
        let config = pages[page_name]
        config.page_name = page_name
        this._register_page(config)
      }
      this._register_page({
        "link": "*",
        "page_name": "page-0000",
        "title": "Pagina non trovata"
      })
    }

    _register_page (config) {
      page(config.link, this._handle_route(config))
    }

    _register_menus (menus, pages) {
      for (let name in menus) {
        let menu = menus[name]
        let links = menu.links
        this._resolve_links(links, pages)
      }
    }

    _resolve_links (links, pages) {
      links.forEach((link) => {
        this._resolve_link(link, pages)
      })
    }

    _resolve_link (link, pages) {
      let page = pages[link.page]
      link.link = page.link
    }

    _handle_route (config) {
      return (route) => {
        config.route = route
        this.open_page(config)
      }
    }

    _redirect () {
      let redirect = sessionStorage.redirect
      if (redirect) {
        this._pathname = redirect
        sessionStorage.removeItem('redirect')
      }
      page(this._pathname)
    }

    open_page (config) {
      let page_name = config.page_name
      if (this._page_name == page_name) {
        return
      }

      let page_url = this.constructor.page_url(page_name)

      if (this._page && this._page.isConnected) {
        this._page.remove()
        this._page
      }

      this.import_page(page_url).then(() => {
        let page = this._pages[page_name]
        if (!page) {
          page = document.createElement(page_name)
          this._pages[page_name] = page
        }

        let data = Object.assign({}, Pantarei.data, config)
        data.brand = this.constructor.brand
        data.links = Pantarei.menu.main.links
        data.selected_menu = -1

        if (data.links) {
          let links = data.links

          let page_name
          let index

          page_name = config.parent || config.page_name
          for (let i = 0, n = links.length; i < n; i += 1) {
            let link = links[i]
            if (link.page === page_name) {
              index = i
            }
          }

          if (index >= 0) {
            data.selected_menu = index
          }
        }

        if (config.menu) {
          let links = Pantarei.menu[config.menu].links
          data.menu = links

          let page_name
          let index

          page_name = config.page_name
          for (let i = 0, n = links.length; i < n; i += 1) {
            let link = links[i]
            if (link.page === page_name) {
              index = i
            }
          }

          if (index >= 0) {
            data.selected = index
          }
        }

        this._page_name = page_name
        this._page = page

        this.refs.container.appendChild(this._page)

        this._page.data = data

        let path = `/${config.route.pathname}`
        window.scrollTo(0, 0)
        window.ga && window.ga('send', 'pageview', path)
      }).catch((err) => {
        console.warn(err)
        page('/')
      })
    }

    import_page (href) {
      let link = this._imported[href]
      if (link) {
        return link
      }

      return new Promise((resolve, reject) => {
        let link = document.createElement('link')
        link.rel = 'import'
        link.href = href

        link.onload = (event) => {
          this._imported[href] = Promise.resolve(link)
          resolve(link)
        }
        link.onerror = (event) => {
          reject(link)
        }

        document.head.appendChild(link)
      })
    }

  }

  window.customElements.define('app-container', AppContainer)
</script>
